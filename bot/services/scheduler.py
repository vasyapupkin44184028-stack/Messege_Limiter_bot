"""
–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
"""
import asyncio
from datetime import datetime, timedelta
import logging
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

logger = logging.getLogger(__name__)

scheduler = AsyncIOScheduler()

async def monthly_reset():
    """
    –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 00:01
    """
    try:
        from ..database import db
        
        logger.info("üîÑ –ù–∞—á–∏–Ω–∞—é –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤...")
        
        # 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã
        reset_count = await db.monthly_reset_counts()
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–µ–∫—à–∏–µ —Ä—É—á–Ω—ã–µ –ª–∏–º–∏—Ç—ã
        custom_reset_count = await db.check_and_reset_expired_custom_limits()
        
        # 3. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        unblock_count = await db.auto_unblock_users()
        
        logger.info(f"‚úÖ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω!")
        logger.info(f"üìä –°–±—Ä–æ—à–µ–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤: {reset_count}")
        logger.info(f"‚≠ê –°–±—Ä–æ—à–µ–Ω–æ —Ä—É—á–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤: {custom_reset_count}")
        logger.info(f"üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {unblock_count}")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–º —Å–±—Ä–æ—Å–µ: {e}")

async def monthly_reset():
    """
    –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 00:01
    """
    try:
        from ..database import db
        
        logger.info("üîÑ –ù–∞—á–∏–Ω–∞—é –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤...")
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        reset_count = await db.reset_all_message_counts()
        
        # –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞
        unblock_count = await db.unblock_expired_users()
        
        # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        await db.backup_statistics()
        
        logger.info(f"‚úÖ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω!")
        logger.info(f"üìä –°–±—Ä–æ—à–µ–Ω–æ —Å—á–µ—Ç—á–∏–∫–æ–≤: {reset_count}")
        logger.info(f"üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {unblock_count}")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–º —Å–±—Ä–æ—Å–µ: {e}")

async def daily_check():
    """
    –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00
    """
    try:
        from ..database import db
        
        logger.info("üîç –í—ã–ø–æ–ª–Ω—è—é –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É...")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–æ–≤ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
        unblocked = await db.check_and_unblock_users()
        
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
        cleared = await db.cleanup_old_logs()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —á–∞—Ç–æ–≤
        checked = await db.check_chats_activity()
        
        logger.info(f"‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        logger.info(f"üîì –ê–≤—Ç–æ—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: {unblocked}")
        logger.info(f"üóëÔ∏è –û—á–∏—â–µ–Ω–æ –ª–æ–≥–æ–≤: {cleared}")
        logger.info(f"üí¨ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–∞—Ç–æ–≤: {checked}")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ: {e}")

async def weekly_backup():
    """
    –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 04:00
    """
    try:
        from ..database import db
        
        logger.info("üíæ –ù–∞—á–∏–Ω–∞—é –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ...")
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î
        backup_file = await db.create_backup()
        
        logger.info(f"‚úÖ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
        logger.info(f"üìÅ –§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: {backup_file}")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")

def setup_scheduler():
    """
    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–¥–∞—á
    """
    try:
        # –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å - 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 00:01
        scheduler.add_job(
            monthly_reset,
            CronTrigger(day=1, hour=0, minute=1),
            id='monthly_reset',
            name='–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤',
            replace_existing=True
        )
        
        # –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00
        scheduler.add_job(
            daily_check,
            CronTrigger(hour=3, minute=0),
            id='daily_check',
            name='–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞',
            replace_existing=True
        )
        
        # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ - –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 04:00
        scheduler.add_job(
            weekly_backup,
            CronTrigger(day_of_week='sun', hour=4, minute=0),
            id='weekly_backup',
            name='–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ',
            replace_existing=True
        )
        
        # –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ - –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        scheduler.add_job(
            lambda: logger.debug("üîÑ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç..."),
            'interval',
            minutes=30,
            id='heartbeat',
            name='–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞'
        )
        
        logger.info("‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        logger.info("   ‚Ä¢ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å: 1-–≥–æ —á–∏—Å–ª–∞, 00:01")
        logger.info("   ‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, 03:00")
        logger.info("   ‚Ä¢ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 04:00")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞: {e}")
        raise

async def start_scheduler():
    """
    –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–¥–∞—á
    """
    try:
        setup_scheduler()
        
        if not scheduler.running:
            scheduler.start()
            logger.info("üöÄ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –∑–∞–ø—É—â–µ–Ω")
            
            # –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            await asyncio.sleep(2)
            logger.info("‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã")
            
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞: {e}")

async def stop_scheduler():
    """
    –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–¥–∞—á
    """
    try:
        if scheduler.running:
            scheduler.shutdown()
            logger.info("‚èπÔ∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞: {e}")

def get_scheduler_info() -> str:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–¥–∞—á–∞—Ö –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    
    Returns:
        str: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–∞—Ö
    """
    if not scheduler.running:
        return "üõë –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    
    jobs = scheduler.get_jobs()
    
    if not jobs:
        return "üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á"
    
    info = "‚è∞ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞:\n\n"
    
    for i, job in enumerate(jobs, 1):
        next_run = job.next_run_time.strftime("%d.%m.%Y %H:%M") if job.next_run_time else "–ù–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ"
        info += f"{i}. {job.name}\n"
        info += f"   üÜî ID: {job.id}\n"
        info += f"   ‚è±Ô∏è –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫: {next_run}\n\n"
    
    info += f"–í—Å–µ–≥–æ –∑–∞–¥–∞—á: {len(jobs)}"
    return info